<!DOCTYPE html>
<html>
<head>
    <base href="." target="_blank">
    <title>{{ displayName }} Embed Tool</title>
</head>

<body data-displayName='{{ displayName }}'>
    <style>
        @font-face {
            font-family: 'Guardian Egyptian Web';
            src: url('https://interactive.guim.co.uk/fonts/guss-webfonts/GHGuardianHeadline/GHGuardianHeadline-Bold.woff2') format('woff2'),
                 url('https://interactive.guim.co.uk/fonts/guss-webfonts/GHGuardianHeadline/GHGuardianHeadline-Bold.woff') format('woff'),
                 url('https://interactive.guim.co.uk/fonts/guss-webfonts/GHGuardianHeadline/GHGuardianHeadline-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-stretch: normal;
        }

        @font-face {
            font-family: 'Guardian Text Egyptian Web';
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Text Egyp Web-Reg.eot');
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Text Egyp Web-Reg.eot?#iefix') format('embedded-opentype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Text Egyp Web-Reg.woff') format('woff'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Text Egyp Web-Reg.ttf') format('truetype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Text Egyp Web-Reg.svg#Guardian Sans Web-Regular') format('svg');
            font-weight: normal;
            font-style: normal;
            font-stretch: normal;
        }

        @font-face {
            font-family: 'Guardian Agate Sans';
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Reg.eot');
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Reg.eot?#iefix') format('embedded-opentype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Reg.woff') format('woff'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Reg.ttf') format('truetype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Reg.svg#Guardian Sans Web-Regular') format('svg');
            font-weight: normal;
            font-style: normal;
            font-stretch: normal;
        }

        @font-face {
            font-family: 'Guardian Agate Sans';
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Bold.eot');
            src: url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Bold.eot?#iefix') format('embedded-opentype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Bold.woff') format('woff'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Bold.ttf') format('truetype'),
                 url('https://interactive.guim.co.uk/fonts/latin1/Guardian Ag Sans 1 Web-Bold.svg#Guardian Sans Web-Regular') format('svg');
            font-weight: bold;
            font-style: normal;
            font-stretch: normal;
        }

        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            color: #121212;
            font-family: 'Guardian Egyptian Web';
            font-weight: 900;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        header {
            position: fixed;
            z-index: 10;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-bottom: 1px solid #dfdfdf;
        }

        .header__link {
            position: relative;
            z-index: 2;
            font-size: 24px;
            line-height: 1.2;
            padding: 12px 20px;
            color: #121212;
            margin: 0;
            display: inline-block;
            background-color: #ffe500;
            border-right: 1px solid #dfdfdf;
            text-decoration: none;
        }

        .header__link:hover {
            background-color: #ffbb50;
        }

        .header__title {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            text-align: center;
            font-size: 24px;
            line-height: 1.2;
            padding: 12px 0;
        }

        main {
            flex-grow: 2;
            display: flex;
        }

        .options,
        .preview {
            width: 50%;
            box-sizing: border-box;
            padding: 60px 20px;
        }

        .options {
            overflow-y: scroll;
            background-color: #f6f6f6;
        }

        .options-group {
            display: none;
        }

        .options-group--current {
            display: block;
        }

        .option {
            position: relative;
            padding: 12px 0;
        }

        .option--visible-on {
            display: none;
        }

        .option.is-visible {
            display: block;
        }

        .options__label {
            font-size: 13px;
            line-height: 1.1;
            font-family: 'Guardian Agate Sans';
            font-weight: bold;
            color: #121212;
            margin: 0px 12px 8px 0;
        }

        .options__main-tip {
            position: relative;
            font-family: 'Guardian Agate Sans';
            font-size: 13px;
            font-weight: bold;
            line-height: 1.1;
            color: #212121;
            padding-bottom: 16px;
            padding-top: 8px;
        }

        .options__main-tip:after {
            content: '';
            position: absolute;
            width: calc(100% + 40px);
            left: -20px;
            bottom: 0;
            height: 2px;
            background-color: #fff;
        }

        .options__tip {
            width: 50%;
            position: absolute;
            top: 0;
            right: 0;
            text-align: right;
            font-family: 'Guardian Agate Sans';
            font-size: 13px;
            font-weight: normal;
            line-height: 1.1;
            color: #676767;
        }

        .options__input {
            box-sizing: border-box;
            width: 100%;
            background-color: #fff;
            border-radius: 0;
            border: 1px solid #dfdfdf;
        }

        .options__input--textarea {
            height: 200px;
        }

        .options__input--checkbox {
            margin: 0;
            display: none;
        }

        .options__checkbox {
            font-family: 'Guardian Agate Sans';
            font-size: 13px;
            padding: 12px 0;
            color: #fff;
            width: 60px;
            text-align: center;
            cursor: pointer;
            display: block;
            margin-left: 120px;
            margin-top: -22px;
        }

        .options__checkbox.is-off {
            background-color: #888;
        }

        .options__checkbox.is-off:hover {
            background-color: #666;
        }

        .options__checkbox.is-on {
            background-color: #47af37;
        }

        .options__checkbox.is-on:hover {
            background-color: #3a902d;
        }

        .options__checkbox.is-off .options__checkbox-switch--off,
        .options__checkbox.is-on .options__checkbox-switch--on {
            display: inline-block;
        }

        .options__checkbox-switch {
            display: none;
        }

        .options__checkbox-switch--off:before {
            content: '';
            background: #fff;
            width: 1em;
            height: 1em;
            display: inline-block;
            border-radius: 4px;
            margin-right: 6px;
            margin-bottom: -2px;
        }

        .options__checkbox-switch--on:after {
            content: '';
            background: #fff;
            width: 1em;
            height: 1em;
            display: inline-block;
            border-radius: 4px;
            margin-left: 6px;
            margin-bottom: -2px;
        }

        .hidden {
            display: none;
        }

        .preview {
            position: fixed;
            left: 50%;
            right: 0;
            top: 0;
            bottom: 0;
            border-left: 1px solid #dfdfdf;
        }

        .preview__wrapper {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #dfdfdf;
            margin-bottom: 12px;
        }

        .preview__iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            margin: auto;
            border: 0;
            height: 500px;
            width: 380px;
            background-color: #fff;
            display: block;
        }

        .preview__iframe--thumbnail {
            width: 140px;
            height: 600px;
        }

        .preview__iframe--inline {
            width: 620px;
        }

        input,
        textarea {
            padding: 8px;
            font-size: 16px;
            line-height: 1.4;
            font-family: 'Guardian Text Egyptian Web';
            resize: none;
            border: 1px solid #dfdfdf;
        }

        select {
            padding: 8px;
            font-size: 16px;
            font-family: 'Guardian Text Egyptian Web';
            height: 36px;
        }

        .export {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #dcdcdc;
            padding: 8px 20px;
        }

        .export__inner {
            display: flex;
            justify-content: center;
        }

        .export__button {
            position: relative;
            overflow: hidden;
            background-color: #ffe500;
            color: #121212;
            padding: 12px;
            display: inline-block;
            font-size: 13px;
            line-height: 1.1;
            font-family: 'Guardian Agate Sans';
            font-weight: bold;
            cursor: pointer;
        }

        .export__button-copied {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            padding: 12px;
            box-sizing: border-box;
            text-align: center;
            background-color: #212121;
            color: #ffe500;
            transition: transform 0.1s linear;
            transform: translateY(100%);
        }

        .export__button.is-copied .export__button-copied {
            transform: translateY(0);
        }

        .export__button:hover {
            background-color: #ffbb50;
        }

        .export__url {
            width: 50%;
            margin-right: 10px;
            display: block;
            border: 1px solid #ccc;
            font-size: 13px;
            line-height: 1.1;
            font-family: 'Guardian Agate Sans';
        }

    </style>

    <header>
        <a target='_self' class='header__link' href='{{ path }}/tools/embed-tool/'>Embed Tool</a>
        <h1 class='header__title'>Make your {{ displayName }} embed</h1>
    </header>

    <main>
        <div class='options'>
            <div class='options__main-tip'>
                {{ tip }}<br />
                Suggested width: {{ size }}
            </div>
            {{#each fields}}
                <div class='option {{#if visibleOn}}option--visible-on{{/if}}' {{#if visibleOn}}data-visible-on='{{#each visibleOn}}{{@key}}:{{ @this }} && {{/each}}'{{/if}}>
                    <h2 class='options__label'>{{ name }}</h2>

                    {{#if tip}}
                        <h3 class='options__tip'>{{ tip }}</h3>
                    {{/if}}

                    {{#switch type}}
                        {{#case 'text'}}
                            <input class='options__input' type='text' value='{{ default }}' name='{{ handlise name }}'>
                        {{/case}}

                        {{#case 'number'}}
                            <input class='options__input' type='number' value='{{ default }}' name='{{ handlise name }}'>
                        {{/case}}

                        {{#case 'checkbox'}}
                            <div class='options__checkbox is-off' data-name='{{ handlise name }}'>
                                <span class='options__checkbox-switch options__checkbox-switch--off'>Off</span>
                                <span class='options__checkbox-switch options__checkbox-switch--on'>On</span>
                            </div>
                            <input class='options__input options__input--checkbox' type='checkbox' name='{{ handlise name }}'>
                        {{/case}}

                        {{#case 'textarea'}}
                            <textarea class='options__input options__input--textarea' name='{{ handlise name }}'>{{ default }}</textarea>
                        {{/case}}

                        {{#case 'select'}}
                            <select name='{{ handlise name }}' class='options__input'>
                                {{#each options}}
                                <option value='{{ this }}'>{{ this }}</option>
                                {{/each}}
                            </select>
                        {{/case}}
                    {{/switch}}
                </div>
            {{/each}}
        </div>

        <div class='preview'>
            <iframe class='preview__iframe preview__iframe--{{ size }}'></iframe>
        </div>
    </main>

    <div class='export'>
        <div class='export__inner'>
            <input type='text' class='export__url'>
            <div class='export__button'>
                <div class='export__button-copied'>Copied!</div>
                Copy Embed Url
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type='text/javascript'>
        var data = {},
            defaultUrl = '{{ path }}/embed/from-tool/{{ handlise name }}/index.html',
            storageSlot;

        function getPageParameters() {
            var query = window.document.location.search.replace('?', '');

            if (!query) {
                return false;
            } else {
                var vars = query.split("&");
                var query_string = {};
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                        pair[1] = decodeURIComponent(pair[1]);

                    if (pair[1] === 'true' || pair[1] === 'false') {
                        pair[1] = JSON.parse(pair[1]);
                    }

                    if (typeof query_string[pair[0]] === "undefined") {
                        query_string[pair[0]] = pair[1];
                    } else if (typeof query_string[pair[0]] === "string") {
                        var arr = [query_string[pair[0]], pair[1]];
                        query_string[pair[0]] = arr;
                    } else {
                        query_string[pair[0]].push(pair[1]);
                    }
                }

                return query_string;
            }
        }

        function populateFields() {
            var values = getPageParameters();
            if (values) {
                var valueNames = Object.keys(values);

                valueNames.forEach(function(value) {
                    var $input = $(`[name='${value}']`);
                    if ($input.length > 0) {
                        if ($input.attr('type') == 'checkbox') {
                            $input.prop('checked', values[value]);
                            if (values[value]) {
                                $input.parent().find('.options__checkbox').removeClass('is-off').addClass('is-on');
                            }
                        } else {
                            $input.val(values[value]);
                        }
                    }
                });
            }
        }

        function buildDataObject() {
            data = {};

            $('.options__input').each(function(i, el) {
                var $option = $(el).parent();

                if (!$option.hasClass('option--visible-on') || ($option.hasClass('option--visible-on') && $option.hasClass('is-visible'))) {
                    if ($(el).attr('type') == 'checkbox') {
                        if ($(el).is(':checked')) {
                            data[$(el).attr('name')] = true;
                        } else {
                            data[$(el).attr('name')] = false;
                        }
                    } else {
                        data[$(el).attr('name')] = $(el).val();
                    }
                }
            });
        }

        function buildURL() {
            var url = defaultUrl + '?'

            $.each(data, function(key, value) {
                url += key + '=' + encodeURIComponent(value) + '&'
            });

            url = url.substring(0, url.length - 1);

            $('.export__url').val(url);
            $('.preview__iframe').attr('src', url);
        }

        function bindings() {
            $('.options__input').change(function() {
                refreshEmbed();
            });

            $('.options__checkbox').click(function() {
                if ($(this).hasClass('is-off')) {
                    $(this).removeClass('is-off').addClass('is-on');
                    $('[name=' + $(this).data('name') + ']').prop('checked', true);
                } else {
                    $(this).removeClass('is-on').addClass('is-off');
                    $('[name=' + $(this).data('name') + ']').prop('checked', false);
                }
                refreshEmbed();
            })

            var timer;

            $('.options__input').on('keyup', function() {
                clearTimeout(timer);
                timer = setTimeout(refreshEmbed, 500);
            });

            $('.options__input').on('keydown', function() {
                clearTimeout(timer);
            });

            var buttonTimer;

            $('.export__button').click(function() {
                var url = document.getElementsByClassName('export__url')[0];
                    url.select();
                    document.execCommand('copy');

                clearTimeout(buttonTimer);
                $('.export__button').addClass('is-copied');
                buttonTimer = setTimeout(function() {
                    $('.export__button').removeClass('is-copied');
                }, 2000);
                pushToLocalStorage();
            });
        }

        function pushToLocalStorage(url) {
            var data = localStorage.getItem('embedSettings');

            if (data === null) {
                data = [];
            } else {
                data = JSON.parse(data);
            }

            if (!storageSlot) {
                storageSlot = data.length;
            } else {
                data.pop();
            }

            data.push({
                url: $('.export__url').val(),
                type: $('body').attr('data-displayName'),
                date: new Date(),
                title: $('[name=\'title\']').val() || $('[name=\'name\']').val() || $('[name=\'document-title\']').val()
            });

            localStorage.setItem('embedSettings', JSON.stringify(data));
        }

        function visibleOnToggles() {
            $('.is-visible').removeClass('is-visible');
            $('.option--visible-on').each(function(i, el) {
                var isVisible = true;
                var values = $(el).data('visible-on');
                    values = values.substring(0, values.length - 4);
                    values = values.split(' && ');

                values.forEach(function(value) {
                    value = value.split(':');
                    var key = value[0];
                    var vals = value[1].split(',');
                    var $prop = $('[name=\'' + key + '\']');

                    if ($prop) {
                        var propState = $prop.attr('type') == 'checkbox' ? $prop.prop('checked') : $prop.val();

                        var matchedCount = 0;

                        vals.forEach(function(val) {
                            if (val !== propState.toString()) {
                                matchedCount++;
                            }
                        });

                        if (vals.length === matchedCount) {
                            isVisible = false;
                        }
                    }
                });

                if (isVisible) {
                    $(el).addClass('is-visible');
                }
            })
        }

        function refreshEmbed() {
            visibleOnToggles();
            buildDataObject();
            buildURL();
        }

        function init() {
            visibleOnToggles();
            populateFields();
            buildDataObject();
            buildURL();
            bindings();
        }

        init();
    </script>
</body>
