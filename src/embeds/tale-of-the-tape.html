<!DOCTYPE html>
<html>
<head>
    <base href="." target="_blank">
    <title>Tale of the Tape Embed</title>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

    <script src="https://interactive.guim.co.uk/libs/iframe-messenger/iframeMessenger.js"></script>
    <script>
        iframeMessenger.enableAutoResize();
    </script>
    <script type='text/javascript' src="../handlebars.min.js"></script>

    <script type='application/json'>
        {
            "type": "General",
            "size": "inline",
            "tip": "Tale of the Tapes can be used to represent two people, players or things in a numerical head-to-head",
            "fields": [
                {
                    "name": "Opinion Tint",
                    "type": "checkbox"
                },

                {
                    "name": "Title A",
                    "type": "text",
                    "default": "Dele Alli"
                },

                {
                    "name": "Description A",
                    "type": "text",
                    "default": "Tottenham midfielder"
                },

                {
                    "name": "Image A",
                    "type": "text",
                    "default": "https://media.gutools.co.uk/images/e7740ca17706ff2988615f2ed40263b027002024?crop=598_43_549_549",
                    "tip": "Link to a square and cropped grid or S3 image"
                },

                {
                    "name": "Colour A",
                    "type": "select",
                    "options": ["Blue", "Red", "Orange", "Brown", "Purple", "Yellow", "Green"]
                },

                {
                    "name": "Title B",
                    "type": "text",
                    "default": "Mesut Ozil"
                },

                {
                    "name": "Description B",
                    "type": "text",
                    "default": "Arsenal midfielder"
                },

                {
                    "name": "Image B",
                    "type": "text",
                    "default": "https://media.gutools.co.uk/images/f6c977f15ceea602fecda59d0ad24051244ea1cc?crop=1357_375_1538_1538",
                    "tip": "Link to a cropped grid or S3 image"
                },

                {
                    "name": "Colour B",
                    "type": "select",
                    "options": ["Red", "Orange", "Blue", "Brown", "Purple", "Yellow", "Green"]
                },

                {
                    "name": "Row 1 Label",
                    "type": "text",
                    "default": "League appearences"
                },

                {
                    "name": "Row 1 Value A",
                    "type": "text",
                    "default": 37
                },

                {
                    "name": "Row 1 Value B",
                    "type": "text",
                    "default": 33
                },

                {
                    "name": "Row 2 Label",
                    "type": "text",
                    "default": "Goals"
                },

                {
                    "name": "Row 2 Value A",
                    "type": "text",
                    "default": 18
                },

                {
                    "name": "Row 2 Value B",
                    "type": "text",
                    "default": "£"
                },

                {
                    "name": "Row 3 Label",
                    "type": "text",
                    "default": "Cost"
                },

                {
                    "name": "Row 3 Value A",
                    "type": "text",
                    "default": "£5m"
                },

                {
                    "name": "Row 3 Value B",
                    "type": "text",
                    "default": "£42.5m"
                },

                {
                    "name": "Row 4 Label",
                    "type": "text"
                },

                {
                    "name": "Row 4 Value A",
                    "type": "text"
                },

                {
                    "name": "Row 4 Value B",
                    "type": "text"
                },

                {
                    "name": "Row 5 Label",
                    "type": "text"
                },

                {
                    "name": "Row 5 Value A",
                    "type": "text"
                },

                {
                    "name": "Row 5 Value B",
                    "type": "text"
                },

                {
                    "name": "Row 6 Label",
                    "type": "text"
                },

                {
                    "name": "Row 6 Value A",
                    "type": "text"
                },

                {
                    "name": "Row 6 Value B",
                    "type": "text"
                },

                {
                    "name": "Row 7 Label",
                    "type": "text"
                },

                {
                    "name": "Row 7 Value A",
                    "type": "text"
                },

                {
                    "name": "Row 7 Value B",
                    "type": "text"
                },

                {
                    "name": "Row 8 Label",
                    "type": "text"
                },

                {
                    "name": "Row 8 Value A",
                    "type": "text"
                },

                {
                    "name": "Row 8 Value B",
                    "type": "text"
                },

                {
                    "name": "Source",
                    "type": "text",
                    "default": "2016-17 Premier League",
                    "tip": "Optional"
                }
            ]
        }
    </script>

    <script type='application/sass'>
        @import './node_modules/sass-mq/mq';
        @import './src/common/style/vars';
        @import './src/common/style/fonts';
        @import './src/common/style/base';

        .wrapper {
            -webkit-font-smoothing: antialiased;
            background-color: $c-white;
            max-width: 620px;
        }

        .wrapper--tint {
            background-color: $c-tint;
        }

        .title {
            font-family: 'Guardian Egyptian Web';
            font-weight: bold;
            font-size: 20px;
            line-height: 1.2;
            margin: 3px 0 0;
        }

        .description {
            font-family: 'Guardian Sans Web';
            font-size: 14px;
            line-height: 1.2;
            margin: 3px 0 0 0;
            color: $c-black;
        }

        .source {
            margin: 0;
            padding: 3px 0 12px;
            font-family: 'Guardian Sans Web';
            font-size: 14px;
            line-height: 1.2;
            color: $c-dark-grey;
            border-bottom: 1px solid $c-light-grey;
        }

        .table {
            border-bottom: 1px solid $c-light-grey;
            border-right: 1px solid $c-light-grey;
        }

        .table__row {
            display: flex;
            border-top: 1px solid $c-light-grey;
        }

        .table__column {
            width: 33%;
            padding: 4px 6px;
            border-left: 1px solid $c-light-grey;
        }

        .table__image-crop {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50px;
            background-color: $c-light-grey;
            overflow: hidden;
        }

        .table__image {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .image {
            width: 100%;
        }

        .table__label {
            font-family: 'Guardian Sans Web';
            font-size: 14px;
            line-height: 1.2;
            display: block;
            margin: 0;
        }

        .table__number {
            display: block;
            font-family: 'Guardian Figures';
            font-size: 24px;
            line-height: 1;
            margin: 0;
            font-weight: normal;
            min-width: 2.4em;

            @include mq(620px) {
                font-size: 38px;
            }
        }

        @mixin colourScheme($name, $c-color) {
            .table--a-#{$name} {
                .table__column--a {
                    .title,
                    .table__number {
                        color: $c-color;
                    }
                }
            }

            .table--b-#{$name} {
                .table__column--b {
                    .title,
                    .table__number {
                        color: $c-color;
                    }
                }
            }
        }

        @include colourScheme('Red', $c-red);
        @include colourScheme('Orange', $c-orange);
        @include colourScheme('Blue', $c-blue);
        @include colourScheme('Brown', $c-brown);
        @include colourScheme('Purple', $c-purple);
        @include colourScheme('Yellow', $c-yellow);
        @include colourScheme('Green', $c-green);
    </script>
</head>

<body>
    <div class='target'>
        <!-- this is where the template will be injected -->
    </div>

    <script class="template" type="text/x-handlebars-template">
        <div class='wrapper wrapper--{{ handlise vertical }} {{#if opinion-tint}}wrapper--tint{{/if}}'>
            <div class='table table--a-{{ colour-a }} table--b-{{ colour-b }}'>
                <div class='table__row table__row--header'>
                    <div class='table__column table__column--a'>
                        {{#if image-a}}
                            <div class='table__image-crop'>
                                <img src='{{ gridToLink image-a }}' class='table__image' />
                            </div>
                        {{/if}}
                        <h2 class='title'>{{ title-a }}</h2>
                        <p class='description'>{{ description-a }}</h2>
                    </div>

                    <div class='table__column'></div>

                    <div class='table__column table__column--b'>
                        {{#if image-b}}
                            <div class='table__image-crop'>
                                <img src='{{ gridToLink image-b }}' class='table__image' />
                            </div>
                        {{/if}}
                        <h2 class='title'>{{ title-b }}</h2>
                        <p class='description'>{{ description-b }}</h2>
                    </div>
                </div>
                {{#each rows}}
                    <div class='table__row'>
                        <div class='table__column table__column--a'>
                            <h2 class='table__number table__number--1'>{{ a }}</h2>
                        </div>
                        <div class='table__column'>
                            <p class='table__label'>{{ title }}</p>
                        </div>
                        <div class='table__column table__column--b'>
                            <h2 class='table__number table__number--2'>{{ b }}</h2>
                        </div>
                    </div>
                {{/each}}
            </div>
            {{#if source}}
                <p class='source'>Source: {{ source }}</p>
            {{/if}}
        </div>
    </script>

    <script type='text/javascript'>
        var params;

        function getPageParameters(query) {
            query = query.split('?')[1];

            var vars = query.split("&");
            var query_string = {};
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                    pair[1] = decodeURIComponent(pair[1]);

                if (pair[1] === 'true' || pair[1] === 'false') {
                    pair[1] = JSON.parse(pair[1]);
                }

                if (typeof query_string[pair[0]] === "undefined") {
                    query_string[pair[0]] = pair[1];
                } else if (typeof query_string[pair[0]] === "string") {
                    var arr = [query_string[pair[0]], pair[1]];
                    query_string[pair[0]] = arr;
                } else {
                    query_string[pair[0]].push(pair[1]);
                }
            }

            query_string.rows = [];

            for (var i = 0; 8 >= i; i++) {
                if (query_string['row-' + i + '-label'] && query_string['row-' + i + '-value-a'] && query_string['row-' + i + '-value-b']) {
                    query_string.rows.push({
                        title: query_string['row-' + i + '-label'],
                        a: query_string['row-' + i + '-value-a'],
                        b: query_string['row-' + i + '-value-b']
                    });
                }
            }

            return query_string;
        }

        function init() {
            Handlebars.registerHelper('handlise', function(string) {
                if (string) {
                    return string.toLowerCase().replace(/ /g, '-').replace(/\//g, '');
                }
            });

            Handlebars.registerHelper('gridToLink', function(url) {
                if (url && url.includes('gutools.co.uk')) {
                    var crop = url.split('?crop=')[1];
                    var cropDimensions = crop.split('_');
                    var cropWidth = cropDimensions[2];
                    var cropHeight = cropDimensions[3];

                    if (cropWidth >= 500) {
                        if (cropHeight > cropWidth) {
                            var ratio = 500 / cropHeight;
                            size = Math.round(cropWidth * ratio);
                        } else {
                            size = 500;
                        }
                    } else {
                        size = cropWidth;
                    }

                    url = url.replace('gutools.co.uk', 'guim.co.uk');
                    url = url.replace('http://', 'https://');
                    url = url.replace('images/', '');
                    url = url.split('?')[0];

                    return url + '/' + crop + '/' + size + '.jpg';
                } else if (url) {
                    return url;
                }
            });

            var source = document.getElementsByClassName('template')[0].innerHTML;
            var template = Handlebars.compile(source);
            var html = template(getPageParameters(document.location.href));

            document.getElementsByClassName('target')[0].outerHTML = html;
        }

        init();
    </script>
</body>
