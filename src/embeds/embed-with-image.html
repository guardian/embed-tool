<!DOCTYPE html>
<html>
<head>
    <base href="." target="_blank">
    <title>Embed with image</title>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

    <script src="https://interactive.guim.co.uk/libs/iframe-messenger/iframeMessenger.js"></script>
    <script>
    iframeMessenger.enableAutoResize();
    </script>
    <script type='text/javascript' src="../handlebars.min.js"></script>

    <script type='application/json'>
    {
        "type": "General",
        "size": "supporting",
        "tip": "Series embeds with images should be used to promote editorial or revenue initiatives. The links provided should be to other pieces of Guardian content only.",
        "fields": [
            {
                "name": "Vertical",
                "type": "select",
                "options": ["News", "Opinion", "Sport", "Lifestyle", "Arts", "Commercial"]
            },

            {
                "name": "Opinion Tint",
                "type": "checkbox"
            },

            {
                "name": "Title",
                "type": "text",
                "default": "Headline for the box: Try to keep it short"
            },

            {
                "name": "Description",
                "type": "textarea",
                "default": "I am the description of the series. This should be short and not be too long. Otherwise people just won't read it."
            },

            {
                "name": "Read More Link",
                "type": "text",
                "default": "https://www.theguardian.com/",
                "tip": "Should link to the series front/tag. Optional"
            },

            {
                "name": "image",
                "type": "text",
                "default": "https://interactive.guim.co.uk/uploader/embed/2019/11/archive-zip/giv-3902SWgn1axoqq8U/placeholder.jpg",
                "tip": "Link to a cropped grid image or an S3 hosted image"
            },

            {
                "name": "Paid For By",
                "type": "checkbox",
                "visibleOn": {
                    "vertical": "Commercial"
                }
            },

            {
                "name": "Paid For Logo",
                "type": "text",
                "default": "https://media.gutools.co.uk/images/c1fe6eeb5075aa20cf7f192a5c25e34f3ba36d8e?crop=0_53_500_192",
                "tip": "Link to a cropped grid image or an S3 hosted image. Best dimensions are 2:1",
                "visibleOn": {
                    "vertical": "Commercial",
                    "paid-for-by": true
                }
            },

            {
                "name": "Paid For Link",
                "type": "text",
                "default": "http://www.nottheguardian.com",
                "tip": "A link to the sponsor's website",
                "visibleOn": {
                    "vertical": "Commercial",
                    "paid-for-by": true
                }
            },

            {
                "name": "Links",
                "type": "checkbox"
            },

            {
                "name": "Link 1 Headline",
                "type": "text",
                "default": "Headline for a story goes here",
                "visibleOn": {
                    "links": true
                }
            },

            {
                "name": "Link 1 Url",
                "type": "text",
                "default": "https://www.theguardian.com/",
                "visibleOn": {
                    "links": true
                }
            },

            {
                "name": "Link 2 Headline",
                "type": "text",
                "default": "Headline for a story goes here",
                "visibleOn": {
                    "links": true
                }
            },

            {
                "name": "Link 2 Url",
                "type": "text",
                "default": "https://www.theguardian.com/",
                "visibleOn": {
                    "links": true
                }
            },

            {
                "name": "Link 3 Headline",
                "type": "text",
                "default": "Headline for a story goes here",
                "visibleOn": {
                    "links": true
                }
            },

            {
                "name": "Link 3 Url",
                "type": "text",
                "default": "https://www.theguardian.com/",
                "visibleOn": {
                    "links": true
                }
            }
        ]
    }
    </script>

    <script type='application/sass'>
    @import './node_modules/sass-mq/mq';
    @import './src/common/style/vars';
    @import './src/common/style/fonts';
    @import './src/common/style/base';

    .wrapper {
        position: relative;
        border-top: 1px solid $c-light-grey;
        border-bottom: 1px solid $c-light-grey;
        max-width: 620px;
    }

    .wrapper--tint {
        background-color: $c-tint;
    }

    .header {
        padding-top: 3px;
        overflow: hidden;
    }

    .title {
        font-family: 'Guardian Egyptian Web';
        font-size: 20px;
        line-height: 1.2;
        font-weight: bold;
        margin: 0;

        @include mq(240px) {
            font-size: 24px;
        }
    }

    .content {
        position: relative;
        color: $c-black;
        font-family: 'Guardian Sans Web';
        font-weight: 400;
        font-size: 14px;
        line-height: 1.3;
        padding: 5px 0;

        @include mq(240px) {
            font-size: 16px;
        }
    }

    a.button {
        background-color: $c-black;
        position: relative;
        display: inline-block;
        font-family: 'Guardian Sans Web';
        font-size: 16px;
        color: #fff;
        padding: 6px 32px 6px 12px;
        border-radius: 32px;
        transition: background 0.4s ease-out;
        cursor: pointer;
        margin-bottom: 10px;
        margin-top: 10px;

        @include mq(240px) {
            font-size: 16px;
        }

        &:hover {
            text-decoration: none;
            background-position: right center;

            svg {
                transform: translateX(2px);
            }
        }
    }

    .button svg {
        position: absolute;
        right: 4px;
        top: 0;
        bottom: 0;
        height: 100%;
        fill: $c-white;
        transition: transform 0.4s ease-out;
    }

    .button svg path {
        fill: $c-white;
    }


    .links {
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
    }

    .link {
        position: relative;
        padding-top: 4px;
        padding: 4px 42px 16px 0;
        margin-top: 4px;
        border-top: 1px solid $c-light-grey;
        font-family: 'Guardian Egyptian Web';
        font-size: 18px;
        font-weight: 500;

        &:after {
            content: '';
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23222' d='M22.8 14.6l-7.6-7.6-.7.7 5.5 6.6h-14v1.5h14l-5.5 6.6.7.7 7.6-7.6v-.9'/%3E%3C/svg%3E%0A");
            background-repeat: no-repeat;
            background-position: 0px;
            background-size: auto;
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, 0.5);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            padding-left: 5px;
            padding-top: 5px;
            position: absolute;
            top: 4px;
            right: 4px;
            bottom: 4px;
            margin: auto;
            display: block;
            transition: color 0.3s ease-out, background 0.3s ease-out, border 0.3s ease-out;
        }

        &:hover:after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath fill='%23fff' d='M22.8 14.6l-7.6-7.6-.7.7 5.5 6.6h-14v1.5h14l-5.5 6.6.7.7 7.6-7.6v-.9'/%3E%3C/svg%3E%0A");
            background-position: 2px;
        }

        a {
            transition: color 0.3s ease-out;
        }

        &:hover a {
            color: $c-black !important;
        }
    }

    .paid-for {
        padding-top: 2px;
        border-top: 1px solid $c-light-grey;
        display: block;
    }

    .paid-for__label {
        margin: 6px 0 3px;
        color: $c-dark-grey;
        font-family: 'Guardian Sans Web';
        font-size: 12px;
    }

    .paid-for__image {
        max-width: 140px;
    }

    .logo_wrapper {
        position: relative;
    }

    .logo {
        max-height: 100px;
        display: block;
        margin-bottom: 6px;
        position: absolute;
        overflow: visible;
        margin-top: 0px;
        right: 10px;
        margin-bottom: 2px;
        padding-top: 12px;
    }


    @mixin colouriseEmbed($vertical, $c-color) {
        .wrapper--#{$vertical} {
            .title,
            .links a {
                color: $c-color;
            }

            .title:hover {
                color: darken($c-color, 5%);
            }

            .link:hover:after {
                background-color: $c-color;
                border-color: $c-color;
            }

            .button {
                background-color: $c-color;

                &:hover {
                    background-color: darken($c-color, 5%);
                }
            }
            .image {
                height: 190px;
                width: 100%;
                overflow: hidden;
                background-color: $c-light-grey;
            }

            .image__image {
                width: 100%;
                display: block;
            }

        }
    }

    @include colouriseEmbed('news', $c-red);
    @include colouriseEmbed('opinion', $c-orange);
    @include colouriseEmbed('sport', $c-blue);
    @include colouriseEmbed('arts', $c-brown);
    @include colouriseEmbed('lifestyle', $c-purple);
    @include colouriseEmbed('commercial', darken($c-teal, 10%));
    </script>
</head>

<body>
    <div class='target'>
        <!-- this is where the template will be injected -->
    </div>

    <script class="template" type="text/x-handlebars-template">
        <div class='wrapper wrapper--{{ handlise vertical }} {{#if opinion-tint}}wrapper--tint{{/if}}'>
            <div class='image'>
                <img src='{{ gridToLink image }}' class='image__image' />
            </div>
            <div class='header'>
                {{#if read-more-link}}
                <a class='title' href='{{ validateURL read-more-link }}'>{{ title }}</a>

                {{ else }}
                <h2 class='title'>{{ title }}
                    {{/if}}
            </div>

                <div class="content">
                    {{ description }}
                </div>
                {{#if links}}
                <ul class='links {{#if link-4-url}}links--4{{/if}}'>
                    {{#if link-1-url}}
                    <a target='_parent' href='{{ validateURL link-1-url }}?CMP=series_embed_box'><li class='link'>{{ link-1-headline }}</li></a>
                    {{/if}}

                    {{#if link-2-url}}
                    <a target='_parent' href='{{ validateURL link-2-url }}?CMP=series_embed_box'><li class='link'>{{ link-2-headline }}</li></a>
                    {{/if}}

                    {{#if link-3-url}}
                    <a target='_parent' href='{{ validateURL link-3-url }}?CMP=series_embed_box'><li class='link'>{{ link-3-headline }}</li></a>
                    {{/if}}
                </ul>
                {{/if}}

                {{#if read-more-link}}
                <a class='button' target='_parent' href='{{ validateURL read-more-link }}'>More from this series <svg class='uit-icon' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'><path d='M38.65 25.58L37 27.21 26.79 37.44l-1.1-1.11 8.53-10.19H12.5v-2.28h21.72l-8.53-10.19 1.1-1.1L37 22.79l1.63 1.63v1.16z'/></svg></a>
                {{/if}}

                {{#if paid-for-by}}
                <a class='paid-for' target='_parent' href='{{ validateURL paid-for-link }}'>
                    <h3 class='paid-for__label'>Paid for by</h3>
                    <img class='paid-for__image' src='{{ gridToLink paid-for-logo }}' />
                </a>
                {{/if}}
            </div>
        </script>

        <script type='text/javascript'>
        var params;

        function getPageParameters(query) {
            query = query.split('?')[1];

            var vars = query.split("&");
            var query_string = {};
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                pair[1] = decodeURIComponent(pair[1]);

                if (pair[1] === 'true' || pair[1] === 'false') {
                    pair[1] = JSON.parse(pair[1]);
                }

                if (typeof query_string[pair[0]] === "undefined") {
                    query_string[pair[0]] = pair[1];
                } else if (typeof query_string[pair[0]] === "string") {
                    var arr = [query_string[pair[0]], pair[1]];
                    query_string[pair[0]] = arr;
                } else {
                    query_string[pair[0]].push(pair[1]);
                }
            }

            return query_string;
        }

        function init() {
            Handlebars.registerHelper('handlise', function(string) {
                return string.toLowerCase().replace(/ /g, '-').replace(/\//g, '');
            });

            Handlebars.registerHelper('gridToLink', function(url) {
                if (url.includes('gutools.co.uk')) {
                    var crop = url.split('?crop=')[1];
                    var cropDimensions = crop.split('_');

                    var cropWidth = cropDimensions[2] - cropDimensions[0];
                    var cropHeight = cropDimensions[3] - cropDimensions[1];

                    if (cropHeight > cropWidth) {
                        var ratio = 500 / cropHeight;
                        size = Math.round(cropWidth * ratio);
                    } else {
                        size = 500;
                    }

                    url = url.replace('gutools.co.uk', 'guim.co.uk');
                    url = url.replace('http://', 'https://');
                    url = url.replace('images/', '');
                    url = url.split('?')[0];

                    return url + '/' + crop + '/' + size + '.jpg';
                } else if (url) {
                    return url;
                }
            });

            Handlebars.registerHelper('validateURL', function(url) {
                if (url.startsWith('http')) {
                    return url;
                } else {
                    return 'http://' + url;
                }
            });

            var source = document.getElementsByClassName('template')[0].innerHTML;
            var template = Handlebars.compile(source);
            var html = template(getPageParameters(document.location.href));

            document.getElementsByClassName('target')[0].outerHTML = html;
        }

        init();
        </script>
    </body>
